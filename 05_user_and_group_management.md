# 第 5 章 ユーザーとグループの管理

## 5-1 ユーザーとグループ

- **ユーザー**：Linux 利用の基本単位。ログインやメール受信など個別の利用者として機能。
- **グループ**：複数ユーザーをまとめて管理する仕組み。特定グループのみが操作可能なファイルやサービスを設定可能。
- 適切な設定により、ファイル・ディレクトリ・プログラムの参照、編集、実行権限を必要なユーザーにのみ付与できる。

## 5-2 システムを管理するユーザー root

- **root**：Linux システム全体を管理する特権ユーザー（スーパーユーザー）。
- 全ファイルへのアクセスやシステム管理コマンド実行が可能。
- 誤操作や悪用のリスクが高いため、厳格な管理が必要。
- root 作業方法：
  - `su` コマンド：ユーザー切替（パスワード必須）
  - `sudo` コマンド：指定コマンドのみ root 権限で実行（推奨）

---

### 5-2-1 su コマンド

- **用途**：一時的に他ユーザー（省略時は root）に切り替え。
- **パスワード**：切替先ユーザーのパスワードが必要（未設定ユーザーには不可）。
- **動作モード**：
  - オプションなし：現在の環境を保持したままユーザー切替。
  - `-` オプション：指定ユーザーで新規ログインしたのと同等の環境で切替。
- **書式**：

  su [-] [ユーザー]

## オプション

    ログインシェルを起動してユーザーを切り替える

---

### 5-2-2 sudo コマンド

- **用途**：許可されたユーザーが指定コマンドのみを root 権限で実行。
- **利点**：
- root パスワードを知らせずに管理作業を依頼できる。
- 実行コマンドがログに記録されるため追跡可能。
- 実行権限は `/etc/sudoers` で制御。
- **書式**

  sudo コマンド

### root 権限取得の手順（sudo 事前学習）

1. **sudo で root パスワードを設定**

   - 実習前に sudo を使って root パスワードを設定しておく

2. **su コマンドで root に切り替え**

```bash

$ su -
パスワード: ※ root のパスワードを入力（非表示）

- id コマンドで root 権限を確認

# id
uid=0(root) gid=0(root) groups=0(root)

```

3. **作業終了後は exit でログアウト**

```bash

# exit

```

- root 権限を使い終わったら必ずログアウトして安全を確保

---

### 5-2-3 sudo コマンドを使って root 権限でコマンドを実行する

sudo コマンドを実行すると、引数として与えられたコマンドを root 権限で実行できます。
普段の作業は一般ユーザーで行ない、必要に応じて sudo コマンドを使ってシステム管理用のコマンドを実行することで、su コマンドなどでユーザーを root に切り替えることなく、root 権限が必要なシステム管理を行えます。

sudo を実行するには、実行する権限が与えられていることと、実行したユーザーのパスワードが必要です。
パスワードは 1 回入力すると、デフォルトで 5 分間は省略できます。
パスワード入力は設定変更で省略させることもできます。権限付与と設定変更は後述します。

- **書式**

  sudo コマンド

  - 一般ユーザーではアクセスできないファイルも、sudo コマンドを使うと root 権限でコマンドを実行しアクセス権限を得ることができます。

- 実行例

```bash

$ id linuc
uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel)

$ tail /var/log/messages
tail: '/var/log/messages' を読み込み用に開くことが出来ません: 許可がありません

$ sudo tail /var/log/messages
[sudo] linuc のパスワード:
Aug 15 12:00:13 localhost systemd[15213]: Created slice User Background Tasks Slice.
Aug 15 12:00:13 localhost systemd[15213]: Starting Cleanup of User's Temporary Files and Directories ...

```

    /var/log/messages は一般ユーザーではアクセスできないログファイルでしたが、sudo コマンドで tail コマンドを root 権限で実行したことでアクセスすることができました。

    以下の説明で sudo コマンドをつけて実行しているコマンドは、すべて root 権限が必要なシステム管理用のコマンドの実行、あるいは root 権限が必要なファイルに対するアクセスを行っています。

- **補足**

  - /var/log/messages は一般ユーザーではアクセスできません。

  - sudo コマンドを付けることで root 権限でコマンドが実行され、アクセス可能になります。

  - sudo コマンドを使うことで、普段は制限された一般ユーザー権限のまま安全にシステム管理が行えます。

- **注意事項**
  - 他人のプライバシーを尊重すること。
  - コマンド実行前に内容を確認して考えること。
  - 大いなる力には大いなる責任が伴うこと。

---

# 5-2-4 wheel グループ所属を確認する

    sudo コマンドは、デフォルトの設定では wheel グループに所属しているユーザーに実行を許可しています。
    id コマンドを実行して、自分の所属しているグループを確認します。

```bash

    $ id
    uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel)
    context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

    wheel グループに所属していることがわかります。
    インストール時に「このユーザーを管理者にする」をチェックして作成したユーザーは、sudo コマンドを実行できるよう wheel グループに最初から所属しています。

---

# 5-2-5 sudo コマンドをパスワード無しで実行できるようにする

sudo コマンドの設定を変更して、パスワード無しで sudo コマンドを実行できるようにします。
sudo コマンドの設定は /etc/sudoers に記述されています。この設定ファイルは vi で直接修正するのではなく、visudo コマンドを実行して修正します。

```bash

$ sudo visudo
[sudo] linuc のパスワード: ※ ユーザー linuc のパスワードを入力（非表示）

```

vi で /etc/sudoers が開けたら、以下の設定行を見つけて変更し、保存、終了します（vi の編集モードでコマンド :wq）。設定は即時有効になります。

```bash

Allows people in group wheel to run all commands

%wheel ALL=(ALL) ALL

```

行頭に「# 」を入れてコメントアウトします。

```bash

# %wheel ALL=(ALL) ALL

```

次のコードの意味：コメントアウトを外すと、wheel グループのユーザーは sudo 実行時に パスワード不要 で全コマンドを実行できる

```bash

## Same thing without a password

# %wheel ALL=(ALL) NOPASSWD: ALL

コメントアウトを外す

# %wheel ALL=(ALL) NOPASSWD: ALL

```

最初の設定は、wheel グループに所属している（%wheel）ユーザーは sudo コマンドを実行できるが、パスワードが必要という設定です。
この設定をコメントアウトして無効にしました。コメントアウトするには行頭に「# 」と記述します。

次の設定は、wheel グループに所属しているすべてのユーザーは sudo コマンドを実行でき、パスワードは不要（NOPASSWD: ALL）という設定です。
この設定の行頭のコメントアウトを外して有効にしました。

前の sudo コマンド実行から 5 分以上時間をあけて、再度 sudo コマンドを実行してみてください。
パスワード入力無しで実行できるようになっています。

---

# 5-3 ユーザーの管理

## 概要

- システム管理者は必要に応じてユーザーを作成・削除する  
  例：ログインして作業させる／メールサーバーのアカウント発行 など

---

## 5-3-1 ユーザーの作成

- 新規ユーザーは `useradd`（root 権限）で作成
- ユーザーは必ず **プライマリグループ** に所属（必要に応じて **サブグループ** も）
- ユーザー情報は **`/etc/passwd`** に保存
- `useradd` 実行で `/home/<ユーザー名>` が自動作成・初期化
- ログイン用パスワードは `passwd` で設定

### 書式

useradd ユーザー名

主なオプション

- -g グループ名：プライマリグループを指定（/etc/group 定義済み）

- -G グループ名 1,グループ名 2,...：サブグループを複数指定

実行例

```bash

$ sudo useradd sato
$ grep sato /etc/passwd
sato:x:1001:1001::/home/sato:/bin/bash
$ ls -ld /home/sato
drwx------. 3 sato sato 78 8月15 14:03 /home/sato

```

---

# 5-3-2 パスワードの設定

## 概要

- パスワードの設定・変更には `passwd` コマンドを使用
- 一般ユーザー：自分のパスワードのみ変更可能（現在のパスワード入力が必要）
- root：すべてのユーザーのパスワードを設定可能（現在のパスワード入力は不要）

## 書式

passwd [ユーザー名]

実行例

```bash

$ sudo passwd sato
ユーザー sato のパスワードを変更。
新しいパスワード:        # 入力（非表示）
新しいパスワードを再入力してください:  # 再入力（非表示）
passwd: すべての認証トークンが正しく更新できました。

```

ポイント

- root が passwd <ユーザー> を実行すると強制的にパスワードを設定可能

- 一般ユーザーが自分のパスワードを変更する場合は、現在のパスワード入力が必要

---

# 5-3-3 root のパスワードを設定して su コマンドを実行する

## 概要

- OS インストール時に root パスワードを設定していないと、`su` コマンドで root に切り替えできない
- `sudo passwd root` で root のパスワードを設定することで、`su` コマンドで切り替え可能になる

## 手順

1. root のパスワードを設定

```bash

$ sudo passwd root
新しいパスワード:        # 入力（非表示）
新しいパスワードを再入力してください: # 再入力（非表示）
passwd: すべての認証トークンが正しく更新できました。

```

2. su コマンドで root に切り替え

```bash

$ su -
パスワード:    # root のパスワードを入力

```

3. root への切り替え確認

```bash

# id
uid=0(root) gid=0(root) groups=0(root)

```

ポイント

- su - により root の環境に完全に切り替え可能

- root での操作はシステム全体に影響を与えるため慎重に実行する必要がある

---

# 5-3-4 ユーザーアカウントの変更

## 概要

- `usermod` コマンドを使ってユーザーのアカウント情報（プライマリグループ・サブグループ）を変更できる
- サブグループを追加する場合は `-a` オプションを併用することで既存の所属グループを維持できる

## 書式

```bash

usermod ユーザー名
  -g グループ   # プライマリグループを変更
  -G グループ   # サブグループを変更（カンマ区切りで複数指定）
  -a            # -G と併用して既存グループを維持しつつ追加

```

実行例

1. 現在のユーザー情報確認

```bash

$ id sato
uid=1001(sato) gid=1001(sato) groups=1001(sato)

```

2. サブグループ wheel を追加（既存グループは上書き）

```bash

$ sudo usermod -G wheel sato
$ id sato
uid=1001(sato) gid=1001(sato) groups=1001(sato),10(wheel)

```

3. サブグループ kvm を追加（既存グループを維持）

```bash

$ sudo usermod -G kvm -a sato
$ id sato
uid=1001(sato) gid=1001(sato) groups=1001(sato),10(wheel),36(kvm)

```

ポイント

- -G だけで指定すると既存のサブグループは上書きされる

- -G と -a を併用すると既存サブグループを維持したまま追加可能

---

# 5-3-5 ユーザーの削除

## 概要

- `userdel` コマンドを使ってユーザーを削除できる
- `-r` オプションを付けるとホームディレクトリも同時に削除される

## 書式

```bash

userdel ユーザー名
  -r   # ホームディレクトリを削除

```

実行例

1. ユーザー作成と確認

```bash

$ sudo useradd test
$ id test
uid=1002(test) gid=1002(test) groups=1002(test)
$ ls -ld /home/test
drwx------. 3 test test 78 8月15 14:29 /home/test


```

2. ユーザー削除（ホームディレクトリも削除）

```bash

$ sudo userdel -r test
$ id test
id: 'test': no such user
$ ls -ld /home/test
ls: '/home/test' にアクセスできません: そのようなファイルやディレクトリはありません


```

ポイント

- -r オプションでホームディレクトリも削除される

- ユーザーが存在しない場合は id コマンドで確認すると「no such user」と表示される

---

# 5-4 グループの管理

## 概要

- グループを使うことで、複数ユーザーをまとめて管理できる
- システム管理者は必要に応じて新しいグループを作成可能
- グループ情報は `/etc/group` に記述される

## 5-4-1 グループの作成

- `groupadd` コマンドで新しいグループを作成する

### 書式

```bash

groupadd グループ名

```

実行例

1. グループ作成

```bash

$ sudo groupadd test

```

2. ユーザーのサブグループに追加

```bash

$ sudo usermod -G test -a sato

```

3. /etc/group の確認

```bash

$ grep test /etc/group
test:x:1002:sato

```

実行例

- サブグループは /etc/group にユーザー名として記述される

- 上記例では sato が test グループに所属している

---

# 5-4-2 グループの削除

## 概要

- `groupdel` コマンドでグループを削除できる
- 注意点：
  - ユーザーのプライマリグループは削除できない
  - サブグループは削除可能

## 書式

groupdel グループ名

実行例

1. サブグループの削除

```bash

$ sudo groupdel test
$ grep test /etc/group
# 何も表示されない（削除済み）


```

2. プライマリグループの削除（不可）

```bash

$ sudo groupdel linuc
groupdel: ユーザー 'linuc' のプライマリグループは削除できません

```

ポイント

- test グループは sato のサブグループなので削除可能

- linuc グループは linuc のプライマリグループなので削除不可

---

# 5-5 パスワードファイルとシャドウファイル

## 概要

- ユーザー情報は `/etc/passwd` に保存
- パスワードはセキュリティ上 `/etc/shadow` に保存される
- 直接ファイルを編集せず、`useradd` や `passwd` などのコマンドで操作する

---

## 5-5-1 /etc/passwd（パスワードファイル）

- 1 行 = 1 ユーザー
- 区切り文字は `:`
- フィールド構成：

ユーザー名: パスワード: UID: GID: コメント: ホームディレクトリ: ログインシェル

| 項目               | 内容                                     |
| ------------------ | ---------------------------------------- |
| ユーザー名         | システム内のユーザー名（大文字なし推奨） |
| パスワード         | 旧 UNIX では暗号化パスワード、現在は `x` |
| UID                | ユーザー ID 番号                         |
| GID                | プライマリグループ ID 番号               |
| コメント           | 名前や説明                               |
| ホームディレクトリ | ユーザーのホームディレクトリ             |
| ログインシェル     | 起動されるシェル                         |

---

## 5-5-2 /etc/shadow（シャドウファイル）

- パスワードを安全に保存するためのファイル
- 1 行 = 1 ユーザー
- フィールド構成：

ユーザー名: パスワード: 最終変更日: 変更可能日: 変更要求日: 警告日数: 無効日数: 失効日数: 予約

| 項目       | 内容                                        |
| ---------- | ------------------------------------------- |
| ユーザー名 | ユーザー名                                  |
| パスワード | 暗号化されたパスワード                      |
| 最終変更日 | 1970/01/01 から最後に変更された日までの日数 |
| 変更可能日 | パスワード変更可能日までの日数              |
| 変更要求日 | パスワード変更必須までの日数                |
| 警告日数   | パスワード期限前の警告日数                  |
| 無効日数   | パスワード期限後、アカウント無効までの日数  |
| 失効日数   | 1970/01/01 からアカウント無効になる日まで   |
| 予約       | 将来用の予約フィールド                      |

- シャドウファイルも直接編集せず、`passwd` などで操作する

---

# 5-5-3 要約： グループファイル (/etc/group)

## 概要

- グループ情報は `/etc/group` に保存
- 1 行 = 1 グループ
- 区切り文字は `:`
- 直接編集せず、`groupadd` や `usermod` などのコマンドで操作する

---

## /etc/group のフィールド構成

グループ名: パスワード: GID: ユーザー

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| グループ名 | グループの名前                                           |
| パスワード | 旧 UNIX では暗号化されたグループパスワード、不要なら空欄 |
| GID        | グループ ID 番号                                         |
| ユーザー   | 所属するユーザー名リスト（コンマ区切り）                 |

グループファイルは直接編集せず、groupadd などのコマンドで操作するのが推奨されます。

---
