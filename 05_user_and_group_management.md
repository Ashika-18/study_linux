# 第 5 章 ユーザーとグループの管理

## 5-1 ユーザーとグループ

- **ユーザー**：Linux 利用の基本単位。ログインやメール受信など個別の利用者として機能。
- **グループ**：複数ユーザーをまとめて管理する仕組み。特定グループのみが操作可能なファイルやサービスを設定可能。
- 適切な設定により、ファイル・ディレクトリ・プログラムの参照、編集、実行権限を必要なユーザーにのみ付与できる。

## 5-2 システムを管理するユーザー root

- **root**：Linux システム全体を管理する特権ユーザー（スーパーユーザー）。
- 全ファイルへのアクセスやシステム管理コマンド実行が可能。
- 誤操作や悪用のリスクが高いため、厳格な管理が必要。
- root 作業方法：
  - `su` コマンド：ユーザー切替（パスワード必須）
  - `sudo` コマンド：指定コマンドのみ root 権限で実行（推奨）

---

### 5-2-1 su コマンド

- **用途**：一時的に他ユーザー（省略時は root）に切り替え。
- **パスワード**：切替先ユーザーのパスワードが必要（未設定ユーザーには不可）。
- **動作モード**：
  - オプションなし：現在の環境を保持したままユーザー切替。
  - `-` オプション：指定ユーザーで新規ログインしたのと同等の環境で切替。
- **書式**：

  su [-] [ユーザー]

## オプション

    ログインシェルを起動してユーザーを切り替える

---

### 5-2-2 sudo コマンド

- **用途**：許可されたユーザーが指定コマンドのみを root 権限で実行。
- **利点**：
- root パスワードを知らせずに管理作業を依頼できる。
- 実行コマンドがログに記録されるため追跡可能。
- 実行権限は `/etc/sudoers` で制御。
- **書式**

  sudo コマンド

### root 権限取得の手順（sudo 事前学習）

1. **sudo で root パスワードを設定**

   - 実習前に sudo を使って root パスワードを設定しておく

2. **su コマンドで root に切り替え**

```bash

$ su -
パスワード: ※ root のパスワードを入力（非表示）

- id コマンドで root 権限を確認

# id
uid=0(root) gid=0(root) groups=0(root)

```

3. **作業終了後は exit でログアウト**

```bash

# exit

```

- root 権限を使い終わったら必ずログアウトして安全を確保

---

### 5-2-3 sudo コマンドを使って root 権限でコマンドを実行する

    sudo コマンドを実行すると、引数として与えられたコマンドを root 権限で実行できます。
    普段の作業は一般ユーザーで行ない、必要に応じて sudo コマンドを使ってシステム管理用のコマンドを実行することで、su コマンドなどでユーザーを root に切り替えることなく、root 権限が必要なシステム管理を行えます。

    sudo を実行するには、実行する権限が与えられていることと、実行したユーザーのパスワードが必要です。
    パスワードは 1 回入力すると、デフォルトで 5 分間は省略できます。
    パスワード入力は設定変更で省略させることもできます。権限付与と設定変更は後述します。

- **書式**

  sudo コマンド

       - 一般ユーザーではアクセスできないファイルも、sudo コマンドを使うと root 権限でコマンドを実行しアクセス権限を得ることができます。

- 実行例

```bash

$ id linuc
uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel)

$ tail /var/log/messages
tail: '/var/log/messages' を読み込み用に開くことが出来ません: 許可がありません

$ sudo tail /var/log/messages
[sudo] linuc のパスワード:
Aug 15 12:00:13 localhost systemd[15213]: Created slice User Background Tasks Slice.
Aug 15 12:00:13 localhost systemd[15213]: Starting Cleanup of User's Temporary Files and Directories ...

```

    /var/log/messages は一般ユーザーではアクセスできないログファイルでしたが、sudo コマンドで tail コマンドを root 権限で実行したことでアクセスすることができました。

    以下の説明で sudo コマンドをつけて実行しているコマンドは、すべて root 権限が必要なシステム管理用のコマンドの実行、あるいは root 権限が必要なファイルに対するアクセスを行っています。

- **補足**

  - /var/log/messages は一般ユーザーではアクセスできません。

  - sudo コマンドを付けることで root 権限でコマンドが実行され、アクセス可能になります。

  - sudo コマンドを使うことで、普段は制限された一般ユーザー権限のまま安全にシステム管理が行えます。

- **注意事項**
  - 他人のプライバシーを尊重すること。
  - コマンド実行前に内容を確認して考えること。
  - 大いなる力には大いなる責任が伴うこと。

---

# 5-2-4 wheel グループ所属を確認する

    sudo コマンドは、デフォルトの設定では wheel グループに所属しているユーザーに実行を許可しています。
    id コマンドを実行して、自分の所属しているグループを確認します。

```bash

    $ id
    uid=1000(linuc) gid=1000(linuc) groups=1000(linuc),10(wheel)
    context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

    wheel グループに所属していることがわかります。
    インストール時に「このユーザーを管理者にする」をチェックして作成したユーザーは、sudo コマンドを実行できるよう wheel グループに最初から所属しています。

---

# 5-2-5 sudo コマンドをパスワード無しで実行できるようにする

sudo コマンドの設定を変更して、パスワード無しで sudo コマンドを実行できるようにします。
sudo コマンドの設定は /etc/sudoers に記述されています。この設定ファイルは vi で直接修正するのではなく、visudo コマンドを実行して修正します。

```bash

$ sudo visudo
[sudo] linuc のパスワード: ※ ユーザー linuc のパスワードを入力（非表示）

```

vi で /etc/sudoers が開けたら、以下の設定行を見つけて変更し、保存、終了します（vi の編集モードでコマンド :wq）。設定は即時有効になります。

```bash

Allows people in group wheel to run all commands

%wheel ALL=(ALL) ALL

```

行頭に「# 」を入れてコメントアウトします。

```bash

# %wheel ALL=(ALL) ALL

```

次のコードの意味：コメントアウトを外すと、wheel グループのユーザーは sudo 実行時に パスワード不要 で全コマンドを実行できる

```bash

## Same thing without a password

# %wheel ALL=(ALL) NOPASSWD: ALL

コメントアウトを外す

# %wheel ALL=(ALL) NOPASSWD: ALL

```

最初の設定は、wheel グループに所属している（%wheel）ユーザーは sudo コマンドを実行できるが、パスワードが必要という設定です。
この設定をコメントアウトして無効にしました。コメントアウトするには行頭に「# 」と記述します。

次の設定は、wheel グループに所属しているすべてのユーザーは sudo コマンドを実行でき、パスワードは不要（NOPASSWD: ALL）という設定です。
この設定の行頭のコメントアウトを外して有効にしました。

前の sudo コマンド実行から 5 分以上時間をあけて、再度 sudo コマンドを実行してみてください。
パスワード入力無しで実行できるようになっています。
